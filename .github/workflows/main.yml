# Auto-merge PRs when they are mergeable
# NOTE: This workflow uses the pull_request_target event so it runs in the context
# of the base repository and can access repository secrets (required to use a PAT).
# Be careful: do NOT check out or run untrusted code from the PR head in this job.
name: Auto-merge pull requests #test

on:
  pull_request_target:
    types: [opened, reopened, synchronize, ready_for_review]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    steps:
      - name: Validate PR payload
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            if (!pr) throw new Error('No pull_request payload available.');
            core.info(`Detected PR #${pr.number} by ${pr.user.login}`);

      - name: Evaluate and merge PR (using MERGE_TOKEN)
        uses: actions/github-script@v6
        with:
          # Use a personal access token (PAT) stored in repository secret MERGE_TOKEN
          github-token: ${{ secrets.MERGE_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pr_number = pr.number;

            // Skip draft PRs
            if (pr.draft) {
              core.info('PR is a draft — skipping auto-merge.');
              return;
            }

            // Poll for mergeable state (initially can be null)
            let prInfo;
            for (let i = 0; i < 12; i++) {
              prInfo = await github.rest.pulls.get({ owner, repo, pull_number: pr_number });
              if (prInfo.data.mergeable !== null) break;
              core.info('Waiting for mergeable state to compute...');
              await new Promise((r) => setTimeout(r, 2000));
            }

            prInfo = prInfo.data;
            core.info(`mergeable: ${prInfo.mergeable}, mergeable_state: ${prInfo.mergeable_state}`);

            if (!prInfo.mergeable) {
              core.info('PR is not mergeable — skipping auto-merge.');
              return;
            }

            // Optional: ensure required checks are successful before merging.
            // You can enable or remove this block depending on your branch protection rules.
            const combined = await github.rest.checks.getForRef({
              owner,
              repo,
              ref: pr.head.sha
            }).catch(()=>null);

            // Merge the PR
            try {
              await github.rest.pulls.merge({
                owner,
                repo,
                pull_number: pr_number,
                merge_method: 'merge' // or 'squash' or 'rebase'
              });
              core.info(`Merged PR #${pr_number}`);
            } catch (err) {
              core.setFailed(`Failed to merge PR #${pr_number}: ${err.message}`);
            }
